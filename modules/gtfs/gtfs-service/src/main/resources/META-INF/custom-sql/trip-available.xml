<?xml version="1.0" encoding="UTF-8"?>
<custom-sql>
   <sql id="eu.strasbourg.service.gtfs.service.persistence.TripFinder.findTripAvailable"> 
      	<![CDATA[ 
           	SELECT DISTINCT gtfs_trip.*
			FROM gtfs_trip
				INNER JOIN gtfs_route ON gtfs_route.route_id = gtfs_trip.route_id
			    INNER JOIN gtfs_stoptime ON gtfs_stoptime.trip_id = gtfs_trip.trip_id
			WHERE gtfs_trip.service_id IN (
				SELECT DISTINCT service_id
				FROM gtfs_calendar
				WHERE DATE(start_date) <= DATE(NOW())
				AND DATE(end_date) >= DATE(NOW())
				AND CASE dayname(NOW())
						WHEN 'Monday' THEN monday = 1
						WHEN 'Tuesday' THEN tuesday = 1
						WHEN 'Wednesday' THEN wednesday = 1
						WHEN 'Thursday' THEN thursday = 1
						WHEN 'Friday' THEN friday = 1
						WHEN 'Saturday' THEN saturday = 1
						WHEN 'Sunday' THEN sunday = 1
					END
				AND gtfs_calendar.service_id NOT IN (
					SELECT service_id
					FROM gtfs_calendardate
					WHERE DATE(date_) = DATE(NOW())
					AND exception_type = 2
				)
			)
			AND gtfs_stoptime.stop_id = ?
			GROUP BY gtfs_trip.route_id
		]]>
   </sql>
</custom-sql>