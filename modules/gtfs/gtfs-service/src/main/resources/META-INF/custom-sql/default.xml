<?xml version="1.0" encoding="UTF-8"?>
<custom-sql>
    <sql id="eu.strasbourg.service.gtfs.service.persistence.TripFinder.findTripAvailable"> 
      	<![CDATA[ 
           	SELECT any_value(gtfs_Trip.uuid_) as uuid_, any_value(gtfs_Trip.id_) as id_, gtfs_Trip.route_id, any_value(gtfs_Trip.service_id) as service_id, any_value(gtfs_Trip.trip_id) as trip_id, gtfs_Trip.trip_headsign, any_value(gtfs_Trip.direction_id) as direction_id, any_value(gtfs_Trip.block_id) as block_id
			FROM gtfs_Trip
				INNER JOIN gtfs_Route ON gtfs_Route.route_id = gtfs_Trip.Route_id
				INNER JOIN gtfs_StopTime ON gtfs_StopTime.trip_id = gtfs_Trip.trip_id
			WHERE gtfs_Trip.service_id IN (
				SELECT DISTINCT service_id
				FROM gtfs_Calendar
				WHERE DATE(start_date) <= DATE(NOW())
				AND DATE(end_date) >= DATE(NOW())
				AND CASE dayname(NOW())
						WHEN 'Monday' THEN monday = 1
						WHEN 'Tuesday' THEN tuesday = 1
						WHEN 'Wednesday' THEN wednesday = 1
						WHEN 'Thursday' THEN thursday = 1
						WHEN 'Friday' THEN friday = 1
						WHEN 'Saturday' THEN saturday = 1
						WHEN 'Sunday' THEN sunday = 1
					END
				AND gtfs_Calendar.service_id NOT IN (
					SELECT service_id
					FROM gtfs_CalendarDate
					WHERE DATE(date_) = DATE(NOW())
					AND exception_type = 2
				)
			)
			AND gtfs_StopTime.stop_id = ?
			GROUP BY gtfs_Trip.route_id, gtfs_Trip.trip_headsign
		]]>
   </sql>
</custom-sql>