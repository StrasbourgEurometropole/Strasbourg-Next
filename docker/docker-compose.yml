version: '3.5'

services:

  mysql:
    image: mysql-ems
    environment:
      - MYSQL_DATABASE=liferay-db
      - MYSQL_USER=liferay
      - MYSQL_PASSWORD=sully
      - MYSQL_RANDOM_ROOT_PASSWORD=yes
    command:
      - --character-set-server=utf8mb4 
      - --collation-server=utf8mb4_unicode_ci
      - --max-allowed-packet=1024M
    volumes:
      - ${DATA}/mysql/lib:/var/lib/mysql
    networks:
      - liferay-network

  elasticsearch:
    image: elasticsearch-ems
    environment:
# --- For docker-compose (without Swarm mode) ----
#      - bootstrap.memory_lock=true
      - cluster.name=LiferayElasticsearchCluster
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m" 
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ./configs/elasticsearch-ems/synonyms.txt:/usr/share/elasticsearch/config/analysis/synonyms.txt:ro
      - ${DATA}/esdata:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
    networks:
      - liferay-network
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 1g

  liferay:
    image: liferay-ems
    volumes:
      - ./configs/liferay-ems/osgi:/liferay/osgi/configs
      - ./configs/liferay-ems/setenv.sh:/liferay/tomcat-9.0.17/bin/setenv.sh
      - ./configs/liferay-ems/portal-setup-wizard.properties:/liferay/portal-setup-wizard.properties
      - ./configs/liferay-ems/portal-ext.properties:/liferay/portal-ext.properties
      - ./deploy:/liferay/deploy
      - ${DATA}/liferay/doclib:/data/liferay/document_library
    ports:
      - 8080:8080
    depends_on:
      - mysql
      - elasticsearch
    networks:
      - liferay-network


networks:

  liferay-network:
    name: liferay-network
    driver: overlay